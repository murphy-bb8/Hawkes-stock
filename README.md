# 多维 Hawkes 过程建模：从常数基线到外生驱动的递进实验

## 项目简介

本项目围绕 **A 股限价订单簿中的有毒/无毒订单流**，构建 **4 维多元 Hawkes 过程** 模型，研究买卖双方有毒与无毒订单之间的自激励与交叉激励结构。

核心研究问题：
1. 不同价格水平的股票，其订单流自激励强度有何差异？
2. 引入日内时段效应（开盘/午盘/收盘）能否改善基线强度的刻画？
3. 引入价差变化率（re_spread）作为外生驱动项，能否进一步提升模型拟合？

为此，我们设计了 **三种递进的模型变体**，在统一的 GOF v2 评估框架下进行公平对比。

---

## 建模思路与三种模型的递进关系

### 研究对象

- **数据**：2019 年 12 月，沪市 45 只 A 股，按股价分为 High / Mid / Low 三组（各 15 只）
- **4 个事件维度**：

| 维度编号 | 缩写 | 含义 |
|:--------:|:----:|:-----|
| 0 | BT | Buy Toxic — 买方有毒订单 |
| 1 | BN | Buy Not Toxic — 买方无毒订单 |
| 2 | ST | Sell Toxic — 卖方有毒订单 |
| 3 | SN | Sell Not Toxic — 卖方无毒订单 |

- **交易时段**：每日 4 小时 = 14400 秒（9:30–11:30, 13:00–15:00）

### 递进逻辑

```
Model A (常数 μ)          →  Model B (时变 μ)           →  Model C (时变 μ + 外生项)
最简洁的基线假设              引入日内时段结构               引入市场微观结构变量
β = 10 (grid search)        β = 10 (grid search)          β = 50 (grid search)
无外生项                     γ_open / γ_mid / γ_close      γ_open/mid/close + γ_spread·re_spread(t)
```

每一步都在前一步的基础上增加一个建模维度，以检验额外复杂度是否带来统计上的改善。

---

## 模型公式

### Model A — 常数基线 μ（无外生项）

$$\lambda_i(t) = \mu_i + \sum_{j=1}^{4} \sum_{t_k^j < t} A_{ij} \, e^{-\beta(t - t_k^j)}$$

最简洁的多元 Hawkes 模型。基线强度 $\mu_i$ 为常数，不随日内时间变化。

### Model B — 时变基线 μ（日内时段效应）

$$\lambda_i(t) = \mu_i^{\text{corrected}} \cdot \exp\!\bigl(\gamma_{\text{open},i} \cdot \mathbb{I}_{\text{OPEN30}}(t) + \gamma_{\text{mid},i} \cdot \mathbb{I}_{\text{MID}}(t) + \gamma_{\text{close},i} \cdot \mathbb{I}_{\text{CLOSE30}}(t)\bigr) + \sum_{j=1}^{4} \sum_{t_k^j < t} A_{ij} \, e^{-\beta(t - t_k^j)}$$

其中指示函数定义为：

| 指示函数 | 时段 | 含义 |
|:---------|:-----|:-----|
| $\mathbb{I}_{\text{OPEN30}}(t)$ | 9:30–10:00 | 开盘前 30 分钟 |
| $\mathbb{I}_{\text{MID}}(t)$ | 13:00–13:30 | 午盘开盘 30 分钟 |
| $\mathbb{I}_{\text{CLOSE30}}(t)$ | 14:30–15:00 | 收盘前 30 分钟 |

$\mu_i^{\text{corrected}}$ 为经日内效应校正后的基准强度，$\gamma$ 参数刻画各时段对强度的乘性放大/缩小。

### Model C — 时变基线 μ + re_spread 外生项

$$\lambda_i(t) = \mu_i^{\text{corrected}} \cdot \exp\!\bigl(\gamma_{\text{open},i} \cdot \mathbb{I}_{\text{OPEN30}}(t) + \gamma_{\text{mid},i} \cdot \mathbb{I}_{\text{MID}}(t) + \gamma_{\text{close},i} \cdot \mathbb{I}_{\text{CLOSE30}}(t)\bigr) + \sum_{j=1}^{4} \sum_{t_k^j < t} A_{ij} \, e^{-\beta(t - t_k^j)} + \gamma_{\text{spread},i} \cdot \text{re\_spread}(t)$$

在 Model B 的基础上，增加价差变化率 $\text{re\_spread}(t)$ 作为外生驱动项，$\gamma_{\text{spread},i}$ 为其对各维度强度的影响系数。

---

## 参数含义总表

| 参数 | 符号 | 含义 | Model A | Model B | Model C |
|:-----|:----:|:-----|:-------:|:-------:|:-------:|
| 基线强度 | $\mu_i$ | 第 $i$ 维的背景事件到达率 | ✓ | ✓ (corrected) | ✓ (corrected) |
| 激励矩阵 | $A_{ij}$ | 第 $j$ 维事件对第 $i$ 维的激励系数 | ✓ | ✓ | ✓ |
| 衰减参数 | $\beta$ | 激励效应的指数衰减速率 | ✓ (=10) | ✓ (=10) | ✓ (=50) |
| 分枝比 | $\rho(A/\beta)$ | 谱半径，$<1$ 保证平稳性 | ✓ | ✓ | ✓ |
| 开盘效应 | $\gamma_{\text{open},i}$ | 开盘 30 min 的强度乘子 | — | ✓ | ✓ |
| 午盘效应 | $\gamma_{\text{mid},i}$ | 午盘 30 min 的强度乘子 | — | ✓ | ✓ |
| 收盘效应 | $\gamma_{\text{close},i}$ | 收盘 30 min 的强度乘子 | — | ✓ | ✓ |
| 价差外生项 | $\gamma_{\text{spread},i}$ | re_spread 对强度的线性贡献 | — | — | ✓ |

---

## 估计方法

- **似然函数**：多元 Hawkes 过程的精确对数似然（非近似）
- **优化器**：L-BFGS-B（带边界约束）
- **衰减参数**：网格搜索最优 $\beta$（Model A/B 搜索范围 0.3~10，Model C 搜索范围 0.3~50）
- **稳定性约束**：要求分枝比 $\rho < 1$
- **数据拆分**：全量数据拟合 + 70/30 时间切分验证

---

## GOF v2 评估体系

三种模型使用 **完全统一** 的拟合优度评估框架，基于时间重标残差（time-rescaling residuals）：

> 若模型正确，则重标残差 $r_k = \Lambda_i(t_k) - \Lambda_i(t_{k-1})$ 应服从 $\text{Exp}(1)$ 分布，且相互独立。

| 指标 | 符号 | 含义 | 计算方式 | 理想值 |
|:-----|:----:|:-----|:---------|:------:|
| 综合评分 | GOF Score | 加权综合 ∈ [0,1] | $0.3 \times S_{\text{mean}} + 0.3 \times S_{W_1} + 0.2 \times S_{\text{LB}} + 0.2 \times S_{\text{ACF}}$ | → 1 |
| 残差均值偏差 | $\|E[r]-1\|$ | 均值偏离 Exp(1) 理论值 | $\|\bar{r} - 1\|$ | → 0 |
| Wasserstein-1 | $W_1$ | 分布距离（Earth Mover's） | 子采样 5000 点计算 | → 0 |
| QQ-MAE | — | QQ 线偏离 45° 线 | 200 个分位点的平均绝对偏差 | → 0 |
| Ljung-Box | LB Pass | 残差独立性检验 | lag = 5, 10, 20 联合检验 | Pass |
| ACF | — | 自相关函数 | lag 1~20 的自相关系数 | → 0 |

---

## 实验结果

### 数据概况

- **样本期**：2019 年 12 月（22 个交易日）
- **股票数**：45 只沪市 A 股
- **分组依据**：按月均价分为 High（高价）/ Mid（中价）/ Low（低价）各 15 只
- **事件总量**：每只股票约数千至数万个事件

---

### 三种模型核心指标对比

#### 分枝比（Branching Ratio）

| 价格组 | Model A (常数 μ) | Model B (时变 μ) | Model C (时变 μ + exog) |
|:------:|:-----------------:|:-----------------:|:-----------------------:|
| **High** | **0.900 ± 0.037** | **0.900 ± 0.037** | **0.882 ± 0.039** |
| **Mid** | **0.944 ± 0.020** | **0.944 ± 0.020** | **0.931 ± 0.021** |
| **Low** | **0.969 ± 0.009** | **0.969 ± 0.009** | **0.962 ± 0.009** |
| 全部稳定 (BR<1) | 45/45 ✓ | 45/45 ✓ | 45/45 ✓ |

**解读**：
- 三种模型下分枝比一致呈现 **High < Mid < Low** 的梯度，低价股自激励更强
- Model C 的分枝比略低于 A/B，因为部分强度被外生项 $\gamma_{\text{spread}}$ 吸收
- 所有 45 只股票在三种模型下均满足平稳性条件（BR < 1）

#### GOF 综合评分

| 价格组 | Model A (常数 μ) | Model B (时变 μ) | Model C (时变 μ + exog) |
|:------:|:-----------------:|:-----------------:|:-----------------------:|
| **High** | **0.858** | **0.862** | **0.831** |
| **Mid** | **0.853** | **0.847** | **0.783** |
| **Low** | **0.842** | **0.853** | **0.758** |
| 均值 | **0.851** | **0.854** | **0.791** |

#### GOF 全维度通过率（4/4 pass）

| 价格组 | Model A | Model B | Model C |
|:------:|:-------:|:-------:|:-------:|
| **High** | 7/15 (47%) | 9/15 (60%) | 7/15 (47%) |
| **Mid** | 8/15 (53%) | 8/15 (53%) | 5/15 (33%) |
| **Low** | 7/15 (47%) | 8/15 (53%) | 0/15 (0%) |

#### Wasserstein-1 距离

| 价格组 | Model A | Model B | Model C |
|:------:|:-------:|:-------:|:-------:|
| **High** | 0.399 | 0.400 | 0.402 |
| **Mid** | 0.527 | 0.518 | 0.577 |
| **Low** | 0.605 | 0.601 | 0.681 |

#### QQ-MAE

| 价格组 | Model A | Model B | Model C |
|:------:|:-------:|:-------:|:-------:|
| **High** | 0.341 | 0.342 | 0.342 |
| **Mid** | 0.425 | 0.431 | 0.453 |
| **Low** | 0.468 | 0.471 | 0.498 |

#### 残差均值偏差 |Mean−1|

| 价格组 | Model A | Model B | Model C |
|:------:|:-------:|:-------:|:-------:|
| **High** | 0.012 | 0.011 | 0.068 |
| **Mid** | 0.026 | 0.027 | 0.188 |
| **Low** | 0.024 | 0.025 | 0.233 |

**关键发现**：
1. **Model A 与 Model B 的 GOF 非常接近**，时变基线的改善幅度有限，说明日内时段效应主要影响基线水平而非残差分布形态
2. **Model C 的 GOF 反而低于 A/B**，尤其在 Low Price 组（0.758 vs 0.842/0.853），原因是 Model C 使用更高的 $\beta=50$（衰减更快），且外生项 $\gamma_{\text{spread}}$ 在低价股中波动极大，引入了额外的模型误差
3. **三种模型一致显示**：GOF 随价格降低而下降（High > Mid > Low），Toxic 维度 (BT/ST) 拟合质量低于 Non-Toxic 维度 (BN/SN)

---

### 各维度 GOF 详细对比

#### Model A — 常数 μ

| 组 | 维度 | GOF Score | W1 | QQ-MAE | \|Mean−1\| | LB Pass% |
|:--:|:----:|:---------:|:---:|:------:|:----------:|:--------:|
| **High** | BT | 0.864 | 0.416 | 0.364 | 0.013 | 73% |
| | BN | 0.868 | 0.325 | 0.277 | 0.012 | 93% |
| | ST | 0.844 | 0.463 | 0.393 | 0.013 | 80% |
| | SN | 0.857 | 0.388 | 0.330 | 0.011 | 93% |
| **Mid** | BT | 0.840 | 0.617 | 0.495 | 0.028 | 93% |
| | BN | 0.875 | 0.404 | 0.338 | 0.023 | 80% |
| | ST | 0.846 | 0.599 | 0.502 | 0.030 | 87% |
| | SN | 0.853 | 0.485 | 0.385 | 0.024 | 87% |
| **Low** | BT | 0.796 | 0.820 | 0.619 | 0.036 | 80% |
| | BN | 0.886 | 0.342 | 0.273 | 0.012 | 87% |
| | ST | 0.812 | 0.829 | 0.654 | 0.039 | 87% |
| | SN | 0.874 | 0.430 | 0.328 | 0.012 | 87% |

#### Model B — 时变 μ

| 组 | 维度 | GOF Score | W1 | QQ-MAE | \|Mean−1\| | LB Pass% |
|:--:|:----:|:---------:|:---:|:------:|:----------:|:--------:|
| **High** | BT | 0.857 | 0.434 | 0.365 | 0.012 | 87% |
| | BN | 0.871 | 0.329 | 0.278 | 0.010 | 87% |
| | ST | 0.873 | 0.452 | 0.394 | 0.012 | 87% |
| | SN | 0.846 | 0.384 | 0.331 | 0.010 | 93% |
| **Mid** | BT | 0.847 | 0.608 | 0.495 | 0.029 | 93% |
| | BN | 0.883 | 0.417 | 0.340 | 0.024 | 93% |
| | ST | 0.847 | 0.593 | 0.502 | 0.031 | 93% |
| | SN | 0.811 | 0.455 | 0.386 | 0.024 | 73% |
| **Low** | BT | 0.821 | 0.789 | 0.622 | 0.035 | 93% |
| | BN | 0.909 | 0.342 | 0.274 | 0.012 | 93% |
| | ST | 0.801 | 0.860 | 0.658 | 0.040 | 67% |
| | SN | 0.882 | 0.414 | 0.330 | 0.012 | 93% |

#### Model C — 时变 μ + re_spread

| 组 | 维度 | GOF Score | W1 | QQ-MAE | \|Mean−1\| | LB Pass% |
|:--:|:----:|:---------:|:---:|:------:|:----------:|:--------:|
| **High** | BT | 0.822 | 0.431 | 0.371 | 0.074 | 80% |
| | BN | 0.850 | 0.330 | 0.280 | 0.062 | 93% |
| | ST | 0.818 | 0.468 | 0.394 | 0.074 | 80% |
| | SN | 0.833 | 0.381 | 0.323 | 0.061 | 87% |
| **Mid** | BT | 0.754 | 0.686 | 0.525 | 0.212 | 80% |
| | BN | 0.825 | 0.431 | 0.354 | 0.159 | 80% |
| | ST | 0.759 | 0.699 | 0.539 | 0.219 | 87% |
| | SN | 0.795 | 0.491 | 0.395 | 0.161 | 80% |
| **Low** | BT | 0.681 | 0.978 | 0.693 | 0.340 | 80% |
| | BN | 0.849 | 0.301 | 0.244 | 0.098 | 80% |
| | ST | 0.661 | 1.067 | 0.763 | 0.393 | 73% |
| | SN | 0.842 | 0.377 | 0.291 | 0.102 | 87% |

---

### 日内时段效应（Model B / Model C 共享）

$\gamma > 0$ 表示该时段强度高于基准，$\gamma < 0$ 表示低于基准。

| 组 | 时段 | BT | BN | ST | SN | 解读 |
|:--:|:----:|:---:|:---:|:---:|:---:|:-----|
| **High** | 开盘 (9:30–10:00) | **+0.72** | **+0.61** | **+0.68** | **+0.58** | 开盘强度翻倍 |
| | 午盘 (13:00–13:30) | −0.05 | −0.01 | −0.03 | −0.03 | 午盘无显著变化 |
| | 收盘 (14:30–15:00) | +0.04 | +0.14 | −0.01 | +0.08 | 收盘效应弱 |
| **Mid** | 开盘 | **+0.74** | **+0.57** | **+0.78** | **+0.52** | 开盘强度翻倍 |
| | 午盘 | +0.03 | +0.01 | −0.05 | +0.01 | 午盘无显著变化 |
| | 收盘 | −0.03 | +0.13 | +0.02 | +0.06 | BN 收盘略升 |
| **Low** | 开盘 | **+0.75** | **+0.30** | **+0.91** | **+0.39** | ST 开盘效应最强 |
| | 午盘 | −0.01 | +0.01 | −0.08 | −0.02 | 午盘无显著变化 |
| | 收盘 | −0.06 | +0.18 | −0.13 | +0.12 | Toxic 收盘降低 |

**规律**：
- **开盘效应一致且显著**：$\gamma_{\text{open}} \approx 0.3 \sim 0.9$，即开盘 30 分钟强度为基准的 1.3~2.5 倍
- **午盘效应接近零**：$|\gamma_{\text{mid}}| < 0.1$，午盘开盘无特殊冲击
- **收盘效应弱且分化**：Non-Toxic 维度略升，Toxic 维度在低价股中略降
- **低价股的 Toxic 维度开盘效应最强**（ST: +0.91），反映低价股开盘时卖方有毒订单激增

---

### 外生项 γ_spread 分析（仅 Model C）

| 组 | γ_BT | γ_BN | γ_ST | γ_SN |
|:--:|:----:|:----:|:----:|:----:|
| **High** | 16.1 ± 18.9 | 40.9 ± 76.1 | 19.5 ± 27.9 | 43.5 ± 98.3 |
| **Mid** | 73.2 ± 48.9 | 95.8 ± 74.1 | 79.4 ± 55.7 | 127.0 ± 155.9 |
| **Low** | 177.3 ± 179.4 | 454.8 ± 328.4 | 107.7 ± 73.8 | 644.8 ± 351.2 |

**发现**：
- $\gamma_{\text{spread}}$ 随价格降低 **数量级增大**（High ~20 → Low ~300），低价股对价差变化极度敏感
- Non-Toxic 维度 (BN/SN) 的 $\gamma_{\text{spread}}$ 普遍大于 Toxic 维度 (BT/ST)
- Low Price 组标准差极大（如 SN: 644.8 ± 351.2），个股异质性显著
- **注意**：$\gamma_{\text{spread}}$ 的巨大波动是 Model C 在低价股 GOF 下降的主要原因之一

---

### 激励矩阵 A 结构（Model B 组均值）

**High Price 组**：

|  | → BT | → BN | → ST | → SN |
|:--:|:----:|:----:|:----:|:----:|
| **BT →** | **0.885** | 0.000 | 0.000 | 0.003 |
| **BN →** | 0.014 | **0.829** | 0.003 | 0.000 |
| **ST →** | 0.000 | 0.003 | **0.885** | 0.002 |
| **SN →** | 0.002 | 0.000 | 0.018 | **0.850** |

**Mid Price 组**：

|  | → BT | → BN | → ST | → SN |
|:--:|:----:|:----:|:----:|:----:|
| **BT →** | **0.942** | 0.000 | 0.000 | 0.002 |
| **BN →** | 0.014 | **0.892** | 0.001 | 0.000 |
| **ST →** | 0.000 | 0.002 | **0.923** | 0.000 |
| **SN →** | 0.000 | 0.000 | 0.024 | **0.902** |

**Low Price 组**：

|  | → BT | → BN | → ST | → SN |
|:--:|:----:|:----:|:----:|:----:|
| **BT →** | **0.967** | 0.000 | 0.000 | 0.000 |
| **BN →** | 0.004 | **0.881** | 0.001 | 0.000 |
| **ST →** | 0.000 | 0.001 | **0.964** | 0.000 |
| **SN →** | 0.000 | 0.001 | 0.013 | **0.914** |

**结构特征**：
- **对角线主导**：自激励远强于交叉激励（$A_{ii} \gg A_{ij}, i \neq j$）
- **Toxic 维度自激励更强**：$A_{\text{BT,BT}} > A_{\text{BN,BN}}$，$A_{\text{ST,ST}} > A_{\text{SN,SN}}$
- **低价股自激励更强**：Low 组对角线值 > Mid > High
- **微弱的交叉激励**：SN → ST 存在约 0.01~0.02 的交叉效应，其余交叉项接近零

---

### 基线强度 μ 组均值（Model B）

| 组 | μ_BT | μ_BN | μ_ST | μ_SN | 特征 |
|:--:|:----:|:----:|:----:|:----:|:-----|
| **High** | 0.054 ± 0.027 | 0.083 ± 0.038 | 0.051 ± 0.020 | 0.069 ± 0.018 | BN > SN > BT ≈ ST |
| **Mid** | 0.057 ± 0.056 | 0.095 ± 0.058 | 0.066 ± 0.059 | 0.086 ± 0.052 | BN > SN > ST > BT |
| **Low** | 0.012 ± 0.013 | 0.070 ± 0.016 | 0.011 ± 0.013 | 0.051 ± 0.022 | BN ≫ SN ≫ BT ≈ ST |

**解读**：
- **Non-Toxic 维度的背景强度远高于 Toxic 维度**：μ_BN/μ_SN 约为 μ_BT/μ_ST 的 1.5~6 倍，说明无毒订单的"自发到达"更频繁
- **低价股的 Toxic 背景强度极低**（μ_BT ≈ μ_ST ≈ 0.01），有毒订单几乎完全由自激励驱动而非背景到达
- **高价股各维度背景强度更均衡**，反映其订单簿流动性更好

### AIC 对比（Model B）

| 组 | AIC (mean ± std) |
|:--:|:----------------:|
| **High** | −29.7 ± 37.8 |
| **Mid** | −83.4 ± 60.2 |
| **Low** | −92.8 ± 41.7 |

AIC 越小越好。Low Price 组的 AIC 最低，说明尽管 GOF 残差偏差较大，模型在似然意义上对低价股的拟合仍然较好（事件数量更多，似然值更高）。

---

## 综合结论

### 三种模型的优劣总结

| 维度 | Model A (常数 μ) | Model B (时变 μ) | Model C (+exog) |
|:-----|:-----------------|:-----------------|:----------------|
| **复杂度** | 最低（$\mu, A, \beta$） | 中等（+$\gamma_{\text{open/mid/close}}$） | 最高（+$\gamma_{\text{spread}}$） |
| **GOF 评分** | 0.851 | **0.854** (最优) | 0.791 |
| **残差均值偏差** | **0.021** (最优) | 0.021 | 0.163 |
| **Wasserstein-1** | **0.510** | 0.506 | 0.553 |
| **独立性 (LB)** | 85% | **88%** (最优) | 82% |
| **参数可解释性** | 高 | 高 | 中（$\gamma_{\text{spread}}$ 波动大） |
| **适用场景** | 基准对比 | **推荐默认选择** | 需要微观结构分析时 |

### 核心发现

1. **Model B（时变 μ）是最佳平衡点**：在几乎不增加计算成本的前提下，通过日内时段效应校正获得了最优的 GOF 评分和独立性检验通过率

2. **Model C 的外生项引入了过拟合风险**：$\gamma_{\text{spread}}$ 在低价股中波动极大（CV > 100%），导致 GOF 反而下降。但 Model C 揭示了重要的经济学含义——低价股对价差变化的敏感度远高于高价股

3. **价格效应是最稳健的发现**：三种模型一致显示：
   - 分枝比：High (0.90) < Mid (0.94) < Low (0.97)
   - GOF：High > Mid > Low
   - Toxic 维度拟合难度 > Non-Toxic 维度

4. **开盘效应是最显著的日内结构**：$\gamma_{\text{open}} \approx 0.5 \sim 0.9$，开盘 30 分钟的事件强度约为基准的 1.5~2.5 倍

---

## 经济学解读

### 一、订单流自激励与市场微观结构

#### 1. 有毒订单的"传染性"远强于无毒订单

三种模型一致显示，**Toxic 维度（BT/ST）的自激励系数 $A_{ii}$ 显著高于 Non-Toxic 维度（BN/SN）**：

| 价格组 | $A_{\text{BT,BT}}$ | $A_{\text{BN,BN}}$ | $A_{\text{ST,ST}}$ | $A_{\text{SN,SN}}$ |
|:------:|:-------------------:|:-------------------:|:-------------------:|:-------------------:|
| High | 0.885 | 0.829 | 0.885 | 0.850 |
| Mid | 0.942 | 0.892 | 0.923 | 0.902 |
| Low | 0.967 | 0.881 | 0.964 | 0.914 |

**经济学含义**：有毒订单（informed trading）具有更强的"传染效应"——一笔有毒订单的出现会显著提高后续有毒订单到达的概率。这与市场微观结构理论一致：知情交易者倾向于在信息优势消散前集中下单（strategic order splitting），形成订单簇聚（order clustering）。相比之下，无毒订单（liquidity provision）的自激励较弱，反映流动性提供者的行为更加分散和随机。

#### 2. 低价股的"自激励陷阱"

分枝比随价格降低单调递增（High 0.90 → Mid 0.94 → Low 0.97），且低价股的 Toxic 自激励接近临界值（$A_{\text{BT,BT}} = 0.967$）。

**经济学含义**：
- **流动性差异**：低价股的订单簿深度浅、买卖价差大，单笔订单对价格的冲击更大，从而触发更多的跟随订单（momentum trading / herding）
- **信息不对称更严重**：低价股的分析师覆盖少、信息透明度低，知情交易者的信息优势更持久，导致有毒订单的连锁反应更强
- **接近临界态**：分枝比 0.97 意味着系统接近不稳定边界（BR = 1），一个微小的外部冲击就可能引发长时间的订单簇聚，这与低价股常见的"闪崩"现象一致

#### 3. 背景强度 μ 揭示的流动性结构

低价股的 Toxic 背景强度极低（μ_BT ≈ μ_ST ≈ 0.01），而 Non-Toxic 背景强度相对正常（μ_BN ≈ 0.07）。

**经济学含义**：
- 低价股中，有毒订单几乎 **不存在"自发到达"**，而是完全由自激励机制驱动——即有毒订单只在已有有毒订单出现后才会跟随出现
- 这意味着低价股的知情交易具有 **高度事件驱动** 的特征：一旦某个信息事件触发第一笔有毒订单，后续订单会以极高的自激励强度（$A_{ii} > 0.96$）持续涌入
- 高价股的 μ 更均衡（Toxic 与 Non-Toxic 差距较小），反映其订单簿生态更健康，知情与非知情交易者共存

### 二、日内时段效应的市场行为解读

#### 1. 开盘效应：信息释放与流动性竞争

开盘 30 分钟（9:30–10:00）的强度放大因子 $\gamma_{\text{open}} \approx 0.5 \sim 0.9$，即事件到达率为基准的 **1.5~2.5 倍**。

**经济学含义**：
- **隔夜信息消化**：A 股实行 T+1 交易制度，隔夜积累的信息（公告、海外市场变动等）在开盘时集中释放，导致知情交易者和流动性提供者同时涌入
- **价格发现集中期**：开盘阶段是价格发现最活跃的时段，买卖双方的有毒和无毒订单都显著增加
- **低价股 ST 开盘效应最强**（$\gamma_{\text{open}} = 0.91$）：低价股的卖方有毒订单在开盘时激增，可能反映了机构投资者利用隔夜信息进行的集中抛售

#### 2. 午盘效应接近零：市场的"午休惯性"

$|\gamma_{\text{mid}}| < 0.1$，午盘开盘（13:00–13:30）几乎没有额外的强度变化。

**经济学含义**：与欧美市场的连续交易不同，A 股的午间休市（11:30–13:00）并未造成显著的信息积累。午盘开盘时的订单流模式与日内基准无异，说明 **1.5 小时的午休不足以产生类似隔夜的信息冲击**。

#### 3. 收盘效应的分化：Non-Toxic 略升，Toxic 略降

收盘前 30 分钟（14:30–15:00），Non-Toxic 维度的 $\gamma_{\text{close}}$ 略为正值（+0.08~+0.18），而 Toxic 维度在低价股中为负值（−0.06~−0.13）。

**经济学含义**：
- **流动性提供者的收盘效应**：做市商和被动投资者倾向于在收盘前调整持仓（rebalancing），导致无毒订单略增
- **知情交易者的收盘回避**：有毒订单在收盘前减少，可能因为 (a) 知情交易者已在日内完成交易，(b) 收盘前的监管关注度更高（如异常交易监控），(c) T+1 制度下收盘前建仓的风险更大

### 三、价差外生项的经济学意义

#### re_spread 对不同价格水平股票的差异化影响

$\gamma_{\text{spread}}$ 从 High 组的 ~20 增长到 Low 组的 ~300，增幅超过 **10 倍**。

**经济学含义**：
- **价差是低价股订单流的核心驱动因素**：低价股的买卖价差占股价比例更高（相对价差更大），价差的微小变化就会显著改变交易成本，从而触发大量订单
- **Non-Toxic 维度对价差更敏感**（$\gamma_{\text{BN}} > \gamma_{\text{BT}}$，$\gamma_{\text{SN}} > \gamma_{\text{ST}}$）：流动性提供者（做市商、被动投资者）对交易成本变化更敏感，价差收窄时会积极提供流动性，价差扩大时则撤回
- **$\gamma_{\text{spread}}$ 的高波动性**（Low 组 CV > 100%）反映了低价股之间的巨大异质性：部分低价股（如银行股 601398）的订单流高度依赖价差变化，而另一些（如 601319）则不然

#### 模型选择的实践启示

| 应用场景 | 推荐模型 | 理由 |
|:---------|:---------|:-----|
| **订单流预测** | Model B | GOF 最优，参数稳定，计算快 |
| **交易成本分析（TCA）** | Model C | 需要 $\gamma_{\text{spread}}$ 量化价差对订单流的影响 |
| **市场监控/异常检测** | Model A | 最简洁，分枝比直接反映自激励强度 |
| **做市策略优化** | Model C | 需要同时考虑日内时段和价差效应 |
| **学术研究/基准对比** | Model A + B | 递进对比，展示模型复杂度的边际贡献 |

### 四、研究局限与未来方向

1. **样本期较短**：仅使用 2019 年 12 月数据，结论的时间稳健性有待验证
2. **衰减参数固定**：$\beta$ 通过网格搜索选取但在组内固定，未来可考虑个股级别的 $\beta$ 估计
3. **交叉激励稀疏**：当前模型中交叉激励项接近零，可能是因为 4 维模型的参数空间过大，未来可尝试结构化约束（如对称性、稀疏性先验）
4. **外生变量选择**：仅使用 re_spread 作为外生项，未来可引入更多微观结构变量（如订单簿不平衡 OBI、对手方深度 log_opp_depth 等，数据中已包含这些字段）
5. **非参数基线**：日内时段效应使用分段常数近似，未来可考虑核平滑或样条基线

---

## 目录结构

```text
full_test/
├─ hawkes_4d_tick.py              # 4D Hawkes 核心：Model A + Model B 的拟合与 GOF v2
├─ hawkes_4d_tick_exog.py         # 4D Hawkes 核心：Model C（含 re_spread 外生项）
├─ fit_price_groups_4d_noexog.py  # 批量拟合 Model A（常数 μ）+ 可视化
├─ fit_price_groups_4d.py         # 批量拟合 Model B（时变 μ）+ 可视化
├─ fit_price_groups_4d_exog.py    # 批量拟合 Model C（时变 μ + exog）+ 可视化
├─ fit_toxic_events.py            # 1D Toxic 事件批量建模
├─ full_vs_simple_1d.py           # 1D 拟合与统一验证
├─ simulate_and_fit_1d.py         # 1D 仿真 → 拟合入口
├─ mhp.py                         # 1D 简易模拟器
├─ data/
│  ├─ high_price_events/          # 高价组 15 只股票事件数据
│  ├─ mid_price_events/           # 中价组 15 只股票事件数据
│  └─ low_price_events/           # 低价组 15 只股票事件数据
├─ results_noexog/                # Model A 输出
│  ├─ high_price_4d_noexog/       #   高价组各股票结果 + summary
│  ├─ mid_price_4d_noexog/        #   中价组
│  └─ low_price_4d_noexog/        #   低价组
├─ results/                       # Model B 输出
│  ├─ high_price_4d/              #   高价组各股票结果 + summary
│  ├─ mid_price_4d/               #   中价组
│  ├─ low_price_4d/               #   低价组
│  └─ price_groups_comparison.json
└─ results_exog/                  # Model C 输出
   ├─ high_price_4d_exog/         #   高价组各股票结果 + summary
   ├─ mid_price_4d_exog/          #   中价组
   ├─ low_price_4d_exog/          #   低价组
   └─ price_groups_comparison_exog.json
```

---

## 运行方式

```powershell
conda activate py385

# Model A — 常数 μ（无外生项）
python fit_price_groups_4d_noexog.py

# Model B — 时变 μ（日内时段效应）
python fit_price_groups_4d.py

# Model C — 时变 μ + re_spread 外生项
python fit_price_groups_4d_exog.py
```

---

## 可视化输出

每种模型运行后在对应目录生成以下图表：

| 文件名 | 内容 |
|:-------|:-----|
| `gof_qq_plots.png` | 3 组 × 4 维 QQ-Exp(1) 诊断图，带 IQR 带和距离度量标注 |
| `distance_metrics_heatmap.png` | Wasserstein / QQ-MAE / \|Mean−1\| 热力图 |
| `acf_independence_panel.png` | 3 组 × 4 维 ACF 柱状图 + Ljung-Box p-value |
| `gof_score_comparison.png` | GOF 综合评分箱线图 + 多指标雷达图 |
| `gof_summary_dashboard.png` | 残差均值箱线图 + 股票级 GOF 评分热力图 |
| `excitation_matrix_heatmaps.png` | 激励矩阵 A 的组均值热力图 |
| `branching_ratio_boxplot.png` | 分枝比分布箱线图 |
| `gamma_spread_comparison.png` | γ_spread 外生项系数组间对比（仅 Model C） |

---

## 环境与依赖

- Python 3.8.5+
- 依赖包：`numpy`, `scipy`, `matplotlib`, `statsmodels`, `tick`

```powershell
conda create -n py385 python=3.8.5
conda activate py385
pip install numpy scipy matplotlib statsmodels tick
```

---

## 参考

- `tick`（Hawkes 建模工具包）：https://x-datainitiative.github.io/tick/
- Hawkes, A. G. (1971). Spectra of some self-exciting and mutually exciting point processes. *Biometrika*, 58(1), 83–90.
- Bacry, E., Mastromatteo, I., & Muzy, J. F. (2015). Hawkes processes in finance. *Market Microstructure and Liquidity*, 1(01).

